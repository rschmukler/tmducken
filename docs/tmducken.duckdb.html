<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>tmducken.duckdb documentation</title><script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-XJYNJF48RM"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XJYNJF48RM');</script><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">TMDucken</span> <span class="project-version">0.8.1-04</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1 current"><a href="tmducken.duckdb.html"><div class="inner"><span>tmducken.duckdb</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="tmducken.duckdb.html#var-close-db"><div class="inner"><span>close-db</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-connect"><div class="inner"><span>connect</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-create-table.21"><div class="inner"><span>create-table!</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-disconnect"><div class="inner"><span>disconnect</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-drop-table.21"><div class="inner"><span>drop-table!</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-get-config-options"><div class="inner"><span>get-config-options</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-initialize.21"><div class="inner"><span>initialize!</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-initialized.3F"><div class="inner"><span>initialized?</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-insert-dataset.21"><div class="inner"><span>insert-dataset!</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-open-db"><div class="inner"><span>open-db</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-sql-.3Edataset"><div class="inner"><span>sql-&gt;dataset</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-sql-.3Edatasets"><div class="inner"><span>sql-&gt;datasets</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">tmducken.duckdb</h1><div class="doc"><div class="markdown"><p>DuckDB C-level bindings for tech.ml.dataset.</p>
<p>Current datatype support:</p>
<ul>
<li>boolean, all numeric types int8-&gt;int64, uint8-&gt;uint64, float32, float64.</li>
<li>string</li>
<li>LocalDate, Instant column types.</li>
</ul>
<p>Example:</p>
<pre><code class="language-clojure">
user&gt; (require '[tech.v3.dataset :as ds])
nil
user&gt; (require '[tmducken.duckdb :as duckdb])
nil
user&gt; (duckdb/initialize!)
10:04:14.814 [nREPL-session-635e9bc8-2923-442b-9fad-da547210617b] INFO tmducken.duckdb - Attempting to load duckdb from "/home/chrisn/dev/cnuernber/tmducken/binaries/libduckdb.so"
true
user&gt; (def stocks
      (-&gt; (ds/-&gt;dataset "https://github.com/techascent/tech.ml.dataset/raw/master/test/data/stocks.csv" {:key-fn keyword})
          (vary-meta assoc :name :stocks)))
#'user/stocks
user&gt; (def db (duckdb/open-db))
#'user/db
user&gt; (def conn (duckdb/connect db))
#'user/conn
user&gt; (duckdb/create-table! conn stocks)
"stocks"
user&gt; (duckdb/insert-dataset! conn stocks)
nil
user&gt; (ds/head (duckdb/sql-&gt;dataset conn "select * from stocks"))

_unnamed [5 3]:

| symbol |       date | price |
|--------|------------|------:|
|   MSFT | 2000-01-01 | 39.81 |
|   MSFT | 2000-02-01 | 36.35 |
|   MSFT | 2000-03-01 | 43.22 |
|   MSFT | 2000-04-01 | 28.37 |
|   MSFT | 2000-05-01 | 25.45 |
</code></pre>
</div></div><div class="public anchor" id="var-close-db"><h3>close-db</h3><div class="usage"><code>(close-db db)</code></div><div class="doc"><div class="markdown"><p>Close the database.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L176">view source</a></div></div><div class="public anchor" id="var-connect"><h3>connect</h3><div class="usage"><code>(connect db)</code></div><div class="doc"><div class="markdown"><p>Create a new database connection from an opened database.
Users should call disconnect to close this connection.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L184">view source</a></div></div><div class="public anchor" id="var-create-table.21"><h3>create-table!</h3><div class="usage"><code>(create-table! conn dataset options)</code><code>(create-table! conn dataset)</code></div><div class="doc"><div class="markdown"><p>Create an sql table based off of the column datatypes of the dataset.  Note that users
can also call <a href="execute-query!">execute-query!</a> with their own sql create-table string.  Note that the
fastest way to get data into the system is <a href="append-dataset!">append-dataset!</a>.</p>
<p>Options:</p>
<ul>
<li><code>:table-name</code> - Name of the table to create.  If not supplied the dataset name will
be used.</li>
<li><code>:primary-key</code> - sequence of column names to be used as the primary key.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L224">view source</a></div></div><div class="public anchor" id="var-disconnect"><h3>disconnect</h3><div class="usage"><code>(disconnect conn)</code></div><div class="doc"><div class="markdown"><p>Disconnect a connection.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L194">view source</a></div></div><div class="public anchor" id="var-drop-table.21"><h3>drop-table!</h3><div class="usage"><code>(drop-table! conn dataset)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L249">view source</a></div></div><div class="public anchor" id="var-get-config-options"><h3>get-config-options</h3><div class="usage"><code>(get-config-options)</code></div><div class="doc"><div class="markdown"><p>Returns a sequence of maps of {:name :desc} describing valid valid configuration
options to the open-db function.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L111">view source</a></div></div><div class="public anchor" id="var-initialize.21"><h3>initialize!</h3><div class="usage"><code>(initialize! {:keys [duckdb-home]})</code><code>(initialize!)</code></div><div class="doc"><div class="markdown"><p>Initialize the duckdb ffi system.  This must be called first should be called only once.
It is safe, however, to call this multiple times.</p>
<p>Options:</p>
<ul>
<li><code>:duckdb-home</code> - Directory in which to find the duckdb shared library.  Users can pass
this in.  If not passed in, then the environment variable <code>DUCKDB_HOME</code> is checked.  If
neither is passed in then the library will be searched in the normal system library
paths.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L81">view source</a></div></div><div class="public anchor" id="var-initialized.3F"><h3>initialized?</h3><div class="usage"><code>(initialized?)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L76">view source</a></div></div><div class="public anchor" id="var-insert-dataset.21"><h3>insert-dataset!</h3><div class="usage"><code>(insert-dataset! conn dataset options)</code><code>(insert-dataset! conn dataset)</code></div><div class="doc"><div class="markdown"><p>Append this dataset using the higher performance append api of duckdb.  This is recommended
as opposed to using sql statements or prepared statements.  That being said the schema of this
dataset must match <em>precisely</em> the schema of the target table.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L290">view source</a></div></div><div class="public anchor" id="var-open-db"><h3>open-db</h3><div class="usage"><code>(open-db path config-options)</code><code>(open-db path)</code><code>(open-db)</code></div><div class="doc"><div class="markdown"><p>Open a database.  <code>path</code> may be nil in which case database is opened in-memory.
For valid config options call <a href="tmducken.duckdb.html#var-get-config-options">get-config-options</a>.  Options must be
passed as a map of string-&gt;string.  As duckdb is dynamically linked configuration options
may change but with <code>linux-amd64-0.3.1</code> current options are:</p>
<pre><code class="language-clojure">tmducken.duckdb&gt; (get-config-options)
[{:name "access_mode",
  :desc "Access mode of the database ([AUTOMATIC], READ_ONLY or READ_WRITE)"}
 {:name "default_order",
  :desc "The order type used when none is specified ([ASC] or DESC)"}
 {:name "default_null_order",
  :desc "Null ordering used when none is specified ([NULLS_FIRST] or NULLS_LAST)"}
 {:name "enable_external_access",
  :desc
  "Allow the database to access external state (through e.g. COPY TO/FROM, CSV readers, pandas replacement scans, etc)"}
 {:name "enable_object_cache",
  :desc "Whether or not object cache is used to cache e.g. Parquet metadata"}
 {:name "max_memory", :desc "The maximum memory of the system (e.g. 1GB)"}
 {:name "threads", :desc "The number of total threads used by the system"}]
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L125">view source</a></div></div><div class="public anchor" id="var-sql-.3Edataset"><h3>sql-&gt;dataset</h3><div class="usage"><code>(sql-&gt;dataset conn sql options)</code><code>(sql-&gt;dataset conn sql)</code></div><div class="doc"><div class="markdown"><p>Execute a query returning a single dataset.  This runs the query in a context that releases the memory used
for the result set before function returns returning a dataset that has no native bindings.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L684">view source</a></div></div><div class="public anchor" id="var-sql-.3Edatasets"><h3>sql-&gt;datasets</h3><div class="usage"><code>(sql-&gt;datasets conn sql options)</code><code>(sql-&gt;datasets conn sql)</code></div><div class="doc"><div class="markdown"><p>Execute a query returning a dataset iterator.  Most data will be read in-place in the result
set which will be link via metadata to the returned dataset.  If you wish to release
the data immediately wrap call in <code>tech.v3.resource/stack-resource-context</code> and clone
each result.</p>
<p>Options:</p>
<ul>
<li><code>:immediate-release?</code> - defaults to false - When true the return value supports efficient
reduction with the caveat the the datasets passed
into the reduction are released immediately after the reduction fn returns.  This allows
us to directly <code>reduce</code> very large result sets <em>but</em> it means that you cannot
<strong>ever let a non-cloned dataset out of the reduction context</strong>.</li>
</ul>
<p>Example:</p>
<pre><code class="language-clojure">
  ;; !!Recommended!! - Results copied into jvm and duckdb-result released immediately after query

tmducken.duckdb&gt; (first (resource/stack-resource-context
                  (mapv dt/clone (sql-&gt;datasets conn "select * from stocks"))))
_unnamed [560 3]:

| symbol |       date | price |
|--------|------------|------:|
|   MSFT | 2000-01-01 | 39.81 |
|   MSFT | 2000-02-01 | 36.35 |
|   MSFT | 2000-03-01 | 43.22 |
|   MSFT | 2000-04-01 | 28.37 |
|   MSFT | 2000-05-01 | 25.45 |
|   MSFT | 2000-06-01 | 32.54 |
|   MSFT | 2000-07-01 | 28.40 |



  ;; Results read in-place, duckdb-result released as some point after dataset falls
  ;; out of scope.  Be extremely careful with this one.

  tmducken.duckdb&gt; (ds/head (sql-&gt;dataset conn "select * from stocks"))
_unnamed [5 3]:

| symbol |       date | price |
|--------|------------|------:|
|   MSFT | 2000-01-01 | 39.81 |
|   MSFT | 2000-02-01 | 36.35 |
|   MSFT | 2000-03-01 | 43.22 |
|   MSFT | 2000-04-01 | 28.37 |
|   MSFT | 2000-05-01 | 25.45 |
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L624">view source</a></div></div></div></body></html>